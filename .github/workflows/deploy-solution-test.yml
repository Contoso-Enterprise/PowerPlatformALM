name: Deploy Solution to Test

on:
   release:
    types: [created]

jobs: 
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Pack Solution
      uses: microsoft/powerplatform-actions/pack-solution@v0
      with:
        solution-file: release/ ${{ vars.POWERPLATFORMSOLUTIONNAME }}.zip
        solution-folder: src/ ${{ vars.POWERPLATFORMSOLUTIONNAME }}
        solution-type: Both
    - name: Add and Commit
      uses: EndBug/add-and-commit@v9
      with:          
        message: 'Commit Solution  ${{ vars.POWERPLATFORMSOLUTIONNAME }}'          
        add: 'release/* --force'  
    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: packed-solution
        path: release/
    - name: Variables      
      run: |        
        echo "Solution Name var : ${{ vars.POWERPLATFORMSOLUTIONNAME }}"        
        echo "Solution Name env: ${{ env.POWERPLATFORMSOLUTIONNAME }}"        
        echo "URI ${{ vars.POWERPLATFORMURI }}"        
        echo "Source ${{ vars.POWERPLATFORMORGURI_STG }}"   
    - name: who-am-i action
      uses: microsoft/powerplatform-actions/who-am-i@v0
      with:
        environment-url: ${{ vars.POWERPLATFORMORGURI_STG }}
        app-id: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTID }}
        client-secret: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTSECRET }}
        tenant-id: ${{ secrets.POWERPLATFORMCONTOSOPRODUCTIONTENANTID }}
    - name: import solution
      uses: microsoft/powerplatform-actions/import-solution@v0
      with:
        environment-url: ${{ vars.POWERPLATFORMORGURI_STG }}
        app-id: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTID }}
        client-secret: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTSECRET }}
        tenant-id: ${{ secrets.POWERPLATFORMCONTOSOPRODUCTIONTENANTID }}
        solution-file: ${{ vars.POWERPLATFORMSOLUTIONNAME }}_managed.zip

