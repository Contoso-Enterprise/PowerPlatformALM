name: Export Solution

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  set-source:
    runs-on: ubuntu-latest    
    environment: ${{ vars.POWERPLATFORMSOURCEENVIRONMENT }}    
    steps:    
    - name: Use variables    
      run: |        
        echo "variable : var URI ${{ vars.POWERPLATFORMORGURI }}"        
        echo "variable Target ${{ vars.POWERPLATFORMTARGETENVIRONMENT }}"        
        echo "variable Source ${{ vars.POWERPLATFORMSOURCEENVIRONMENT }}"    
    - name : set varable      
      uses: marcdomain/set-variables@v1      
      with:        
        variables: |          
          POWERPLATFORMURI: "${{ vars.POWERPLATFORMORGURI }}"    
    - name : check variable      
      run: |          
        echo "uri : ${{ vars.POWERPLATFORMURI }}"
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Variables      
        run: |        
          echo "Solution Name : ${{ vars.POWERPLATFORMSOLUTIONNAME }}"        
          echo "URI ${{ vars.POWERPLATFORMURI }}"        
          echo "Source ${{ vars.POWERPLATFORMSOURCEENVIRONMENT }}"   
          echo "Target ${{ vars.POWERPLATFORMTARGETENVIRONMENT }}"
      - name: Export Unmanaged Solution
        uses: microsoft/powerplatform-actions/export-solution@v0
        with:
          environment-url: ${{ vars.POWERPLATFORMURI }}
          app-id: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTID }}
          client-secret: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTSECRET }}
          tenant-id: ${{ secrets.POWERPLATFORMCONTOSOPRODUCTIONTENANTID }}
          solution-name: ${{ vars.POWERPLATFORMSOLUTIONNAME }}
          solution-output-file: solutions/${{ vars.POWERPLATFORMSOLUTIONNAME }}.zip
          overwrite: true
          managed: false
      - name: Export Managed Solution      
        uses: microsoft/powerplatform-actions/export-solution@v0          
        with:          
          environment-url: ${{ vars.POWERPLATFORMURI }}          
          app-id: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTID }}          
          client-secret: ${{ secrets.POWERPLATFORMMANAGEMENTCLIENTSECRET }}         
          tenant-id: ${{ secrets.POWERPLATFORMCONTOSOPRODUCTIONTENANTID }}          
          solution-name: ${{ vars.POWERPLATFORMSOLUTIONNAME }}
          solution-output-file: solutions/${{ vars.POWERPLATFORMSOLUTIONNAME }}_managed.zip          
          overwrite: true          
          managed: true
      - name: Add and Commit
        uses: EndBug/add-and-commit@v9
        with:
          message: 'Export Solution ${{ vars.POWERPLATFORMSOLUTIONNAME }}'
          add: '. --force'